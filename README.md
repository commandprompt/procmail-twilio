# procmail-twilio

Ansible playbook for procmail-twilio, a simple way to generate Twilio phone calls based on the contents of e-mail.

## Dependencies

* Python 2.7
* Python modules: Flask >= 0.8, twilio >= 3.3.6
* procmail >= 3.22
* shuf (part of coreutils on Debian/Ubuntu and RHEL/CentOS)
* HTTP server (Apache, nginx, etc.)
* BASH and SH shells
* Twilio account
* Ansible >= 2.0
* Redmine, JIRA, BugZilla, etc. (optional)

## What is procmail-twilio?
procmail-twilio is a combination of procmail recipes and a set of (BASH and Python) scripts that use Twilio Python REST API Client
to generate phone calls.

The procmail recipes distributed as part of this playbook are specifically designed to work with Redmine e-mail notifications for
tickets that were assigned a custom "Emergency (Critical)" priority. 

However, it is only an example. Just replace the ~/.procmailrc with one of your own and you can generate calls for almost any event
that registers in e-mail.

## How does it work exactly?

It all works together rather simply.

* All e-mail (generated by Redmine, JIRA, BugZilla, your personal GMail account etc.) goes through a procmail filter
* which looks for an Emergency priority ticket, or some other string that matches a regex in ~/.procmailrc
* and, when found, parses it
* and extracts key information about the ticket: ticket number, project name, who created or updated the ticket,
* generates a TwiML file based on the extracted information,
* executes a BASH script that initializes a Python virtual environment
* and then runs a Python script that makes an actual call.

The HTTP server is required to serve the TwiML file generated by procmail to Twilio via a REST call.

That's it in a nutshell.

To get a closer look at each stage of this process and see how procmail-twilio is used in real-life scenario by Command Prompt, Inc.
see this blog post: https://www.commandprompt.com/blog/generate-phone-calls-for-redmine-emergency-tickets-using-twilio/

## Redmine requirements

It depends on how your Redmine is configured.

One way to set things up is to create a dedicated Redmine user, say procmail-twilio@yourdomain.com, and make it a member of all
projects. You could use a dedicated group for this, configuring permissions accordingly, or use one of the pre-existing suitable groups.
This approach ensures that the dedicated user receives e-mail notificaitons for all ticket updates in all projects.

Additionally, an e-mail account is required for the dedicated Redmine user. This is where all Redmine e-mail notifications will
be sent to and analyzed by procmail.

## HTTP server

In a simple configuration scenario, HTTP server runs on the same server where procmail processes e-mail notifications. 
As procmail writes out a TwiML file to disk, which is eventually served over HTTP to Twilio, the HTTP server must be able to
locate and read this file.

If you need to write out the TwiML file to a remote filesystem consider using NFS, sshfs or some other solution.

## Install procmail-twilio

You need Ansible to install procmail-twilio. 

Just run these commands in your terminal:

`$ git clone https://github.com/commandprompt/procmail-twilio.git`
`$ cd procmail-twilio`
`$ ansible-playbook run.yml --ask-vault-pass -K`

### Configure playbook

Edit roles/procmail-twilio/vars/main.yml and set system username, filesystem paths, etc. as needed.

We highly recommend that you ecnrypt the vars file after entering your Twilio account credentials:

`$ ansible-vault encrypt roles/procmail-twilio/vars/main.yml`

You may also want to modify some template files but you don't really have to.

